{
  "hash": "7688ea6b672a3decb5e0f71cc7d238d3",
  "result": {
    "markdown": "---\ntitle: \"Matching and Subclassification\"\n---\n\n\n\n\n## DAG of online store\n\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-2_10c2d3b0973dbb918692da17c275855c'}\n\n```{.r .cell-code}\nonline_store <- dagify(\n  C ~ A,\n  C ~ B,\n  D ~ C,\n  D ~ A,\n  D ~ B,\n  E ~ A,\n  E ~ B,\n  E ~ D,\n  coords = list(x = c(A = 3, B = 4, C = 3, D = 1, E = 5),\n                y = c(A = 2, B = 2, C = 3, D = 1, E = 1)),\n  labels = list(A = \"age\",\n                B = \"sex\",\n                C = \"pre_avg_purch\",\n                D = \"card\",\n                E = \"avg_purch\")\n)\n\n# Plot DAG\nggdag(online_store) +\n  theme_dag() +\n  geom_dag_point(color = \"lightblue\") +\n  geom_dag_text(color = \"black\") +\n  geom_dag_edges(edge_color = \"black\") +\n  geom_dag_label_repel(aes(label = label))\n```\n\n::: {.cell-output-display}\n![](07_matching_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n## Naive estimate of the average treatment effect\n\nWe estimate the average treatment effect by taking the difference between expected values of sales in treatment group (plus membership) and control group (non plus membership).\n\n$ATE = E[avg\\_purch|card = 1] - E[avg\\_purch|card = 1] = 25.2195$\n\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-3_181aeb1282aa502aac38dddb6b2dee0a'}\n\n```{.r .cell-code}\n# Expected values in treatment group\nE_avgpurch_card_1 = mean(unlist(membership[membership$card == 1,\"avg_purch\"]))\n# Expected values in control group\nE_avgpurch_card_0 = mean(unlist(membership[membership$card == 0,\"avg_purch\"]))\n# Naive estimate of ATE\nE_avgpurch_card_1 - E_avgpurch_card_0\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> [1] 25.2195\n```\n:::\n:::\n\n\nA naive estimate obtained by regressing `avg_purch` on `card`.\n\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-4_61b6a2736698082fd2c57b645110b326'}\n\n```{.r .cell-code}\nmodel_naive <- lm(avg_purch ~ card, data = membership)\nsummary(model_naive)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = membership)\n#> \n#> Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -101.515  -20.684   -0.199   20.424  120.166 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  65.9397     0.3965  166.29   <2e-16 ***\n#> card         25.2195     0.6095   41.38   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 30.11 on 9998 degrees of freedom\n#> Multiple R-squared:  0.1462,\tAdjusted R-squared:  0.1461 \n#> F-statistic:  1712 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n\n\n## Matching methods for more precise estimates\n\n#### 1. (Coarsened) Exact Matching\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-5_4394ddcb907ce89ac4ef09456ce75cac'}\n\n```{.r .cell-code}\n# Without specifying coarsening\n# (1) Matching\ncem <- matchit(card ~ age + sex + pre_avg_purch,\n               data = membership, \n               method = 'cem', \n               estimand = 'ATE')\n# Use matched data\ndf_cem <- match.data(cem)\n\n# (2) Estimation\nmodel_cem <- lm(avg_purch ~ card, data = df_cem, weights = weights)\nsummary(model_cem)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = df_cem, weights = weights)\n#> \n#> Weighted Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -159.349  -20.459   -0.151   19.863  161.528 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  69.9896     0.3984  175.66   <2e-16 ***\n#> card         15.2043     0.6137   24.77   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 30.12 on 9878 degrees of freedom\n#> Multiple R-squared:  0.0585,\tAdjusted R-squared:  0.0584 \n#> F-statistic: 613.7 on 1 and 9878 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n\n#### 2. Nearest-Neighbor Matching\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-6_3983567d0a9ff6e272770e4184a1d76a'}\n\n```{.r .cell-code}\n# (1) Matching\n# replace: one-to-one or one-to-many matching\nnn <- matchit(card ~ age + sex + pre_avg_purch,\n              data = membership,\n              method = \"nearest\", \n              distance = \"mahalanobis\",\n              replace = T)\n\n# Use matched data\ndf_nn <- match.data(nn)\n\n# (2) Estimation\nmodel_nn <- lm(avg_purch ~ card, data = df_nn, weights = weights)\nsummary(model_nn)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = df_nn, weights = weights)\n#> \n#> Weighted Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -132.730  -21.288   -1.675   18.318  146.631 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  76.5634     0.5881  130.19   <2e-16 ***\n#> card         14.5957     0.7514   19.42   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 30.43 on 6907 degrees of freedom\n#> Multiple R-squared:  0.05179,\tAdjusted R-squared:  0.05166 \n#> F-statistic: 377.3 on 1 and 6907 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n\n#### 3. Inverse Probability Weighting\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-7_e6638e851d99f44e837722d8dece9ba0'}\n\n```{.r .cell-code}\n# (1) Propensity scores\nmodel_prop <- glm(card ~ age + sex + pre_avg_purch,\n                  data = membership,\n                  family = binomial(link = \"logit\"))\nsummary(model_prop)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> glm(formula = card ~ age + sex + pre_avg_purch, family = binomial(link = \"logit\"), \n#>     data = membership)\n#> \n#> Coefficients:\n#>                 Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept)   -1.4298676  0.0752043 -19.013   <2e-16 ***\n#> age            0.0011486  0.0017761   0.647    0.518    \n#> sex            0.0359388  0.0412622   0.871    0.384    \n#> pre_avg_purch  0.0148262  0.0009264  16.003   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for binomial family taken to be 1)\n#> \n#>     Null deviance: 13626  on 9999  degrees of freedom\n#> Residual deviance: 13249  on 9996  degrees of freedom\n#> AIC: 13257\n#> \n#> Number of Fisher Scoring iterations: 4\n```\n:::\n\n```{.r .cell-code}\n# Add propensities to table\ndf_aug <- membership %>% mutate(propensity = predict(model_prop, type = \"response\"))\n\n# Extend data by IPW scores\ndf_ipw <- df_aug %>% mutate(\n  ipw = (card/propensity) + ((1-card) / (1-propensity)))\n\n# (2) Estimation\nmodel_ipw <- lm(avg_purch ~ card,\n                data = df_ipw, \n                weights = ipw)\nsummary(model_ipw)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = df_ipw, weights = ipw)\n#> \n#> Weighted Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -205.353  -28.995   -0.275   28.787  214.307 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  70.2628     0.4320  162.66   <2e-16 ***\n#> card         14.9573     0.6109   24.48   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 43.19 on 9998 degrees of freedom\n#> Multiple R-squared:  0.05657,\tAdjusted R-squared:  0.05647 \n#> F-statistic: 599.5 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\n# Plot histogram of estimated propensities\nggplot(df_aug, aes(x = propensity)) +\n  geom_histogram(alpha = .8, color = \"white\", bins=30)\n```\n\n::: {.cell-output-display}\n![](07_matching_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n#### 4. Comparison of methods\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-8_4d74f04e6e76252053290a3b2048a68d'}\n\n```{.r .cell-code}\n# Summary of naive and matching methods\nmodelsummary::modelsummary(list(\"Naive\" = model_naive,\n                                \"CEM\"   = model_cem,\n                                \"NN\"    = model_nn,\n                                \"IPW\"   = model_ipw))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:center;\"> Naive </th>\n   <th style=\"text-align:center;\"> CEM </th>\n   <th style=\"text-align:center;\"> NN </th>\n   <th style=\"text-align:center;\">  IPW </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:center;\"> 65.940 </td>\n   <td style=\"text-align:center;\"> 69.990 </td>\n   <td style=\"text-align:center;\"> 76.563 </td>\n   <td style=\"text-align:center;\"> 70.263 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:center;\"> (0.397) </td>\n   <td style=\"text-align:center;\"> (0.398) </td>\n   <td style=\"text-align:center;\"> (0.588) </td>\n   <td style=\"text-align:center;\"> (0.432) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> card </td>\n   <td style=\"text-align:center;\"> 25.220 </td>\n   <td style=\"text-align:center;\"> 15.204 </td>\n   <td style=\"text-align:center;\"> 14.596 </td>\n   <td style=\"text-align:center;\"> 14.957 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;box-shadow: 0px 1.5px\">  </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.610) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.614) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.751) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.611) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Num.Obs. </td>\n   <td style=\"text-align:center;\"> 10000 </td>\n   <td style=\"text-align:center;\"> 9880 </td>\n   <td style=\"text-align:center;\"> 6909 </td>\n   <td style=\"text-align:center;\"> 10000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> R2 </td>\n   <td style=\"text-align:center;\"> 0.146 </td>\n   <td style=\"text-align:center;\"> 0.058 </td>\n   <td style=\"text-align:center;\"> 0.052 </td>\n   <td style=\"text-align:center;\"> 0.057 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> R2 Adj. </td>\n   <td style=\"text-align:center;\"> 0.146 </td>\n   <td style=\"text-align:center;\"> 0.058 </td>\n   <td style=\"text-align:center;\"> 0.052 </td>\n   <td style=\"text-align:center;\"> 0.056 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> AIC </td>\n   <td style=\"text-align:center;\"> 96483.2 </td>\n   <td style=\"text-align:center;\"> 95595.0 </td>\n   <td style=\"text-align:center;\"> 67134.2 </td>\n   <td style=\"text-align:center;\"> 97072.1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> BIC </td>\n   <td style=\"text-align:center;\"> 96504.8 </td>\n   <td style=\"text-align:center;\"> 95616.6 </td>\n   <td style=\"text-align:center;\"> 67154.7 </td>\n   <td style=\"text-align:center;\"> 97093.7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Log.Lik. </td>\n   <td style=\"text-align:center;\"> −48238.590 </td>\n   <td style=\"text-align:center;\"> −47794.497 </td>\n   <td style=\"text-align:center;\"> −33564.098 </td>\n   <td style=\"text-align:center;\"> −48533.031 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> RMSE </td>\n   <td style=\"text-align:center;\"> 30.11 </td>\n   <td style=\"text-align:center;\"> 30.08 </td>\n   <td style=\"text-align:center;\"> 30.17 </td>\n   <td style=\"text-align:center;\"> 30.54 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\r\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\r\n<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}